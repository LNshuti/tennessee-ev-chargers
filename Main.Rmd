---
output: github_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_chunk$set(warning = FALSE)
knitr::opts_chunk$set(message = FALSE)

repo_path <- "tennessee-ev-chargers"
suppressWarnings(suppressMessages(source(paste0(repo_path, "/manifest.R"))))
```

# Import income data for TN and location data for EV chargers.
```{r}
tn_wide <- 
  read_csv(paste0(repo_path, "/data/tn_medianincome_2019.csv")) %>% 
  janitor::clean_names() %>% 
  mutate(geoid = paste0(geoid))

# Downloaded from https://www.huduser.gov/portal/datasets/usps_crosswalk.html
zip_tract_xwalk <- 
  readxl::read_xlsx(paste0(repo_path, "/data/ZIP_TRACT_122019.xlsx")) %>%
  janitor::clean_names() %>% 
  rename(geoid = tract)

sf_county <-
  read_sf(paste0(repo_path,
                 "/data/county/01_county-shape-file.shp")) %>% 
  st_transform(crs = 4326) %>% 
  filter(statefp == "47") %>% 
  left_join(tn_wide, by = "geoid")

alt_fuel_stations_tn <- 
  read_csv("tn-chargers/data/alt_fuel_stations.csv") %>%
  janitor::clean_names() %>%
  filter(state == "TN" & fuel_type_code == "ELEC") %>%
  select(station_name, street_address, city, zip, cards_accepted, 
         latitude, longitude)

tn_stations_carded <- 
  alt_fuel_stations_tn %>%
  filter(!is.na(cards_accepted))
```


```{r}
# Counties
tn_income_plt <-
  sf_county %>%
  ggplot() + 
  geom_sf(aes(fill = medinc_e)) +
  scale_fill_gradient2(low = scales::muted("blue"),
                       mid = "white",high = scales::muted("red"),
                       midpoint = 44122,limits = c(0,150000)) + 
  coord_sf(datum=NA) + 
  labs(fill="") + 
  ggtitle("Tennessee Median Income by county, 2019") + 
  ggthemes::theme_tufte(base_family = "Gill Sans")

# ggsave(tn_income_plt,
#        filename = paste0(repo_path, "/output/tn_income_2019.png"), 
#        width = 8, height = 4)
```

# Add EV charging locations
```{r}
nashville_stations <- 
  alt_fuel_stations_tn %>% 
  filter(city == "Nashville") %>% 
  mutate(unique_stations = stringr::word(station_name, 1,2, sep=" ")) %>% 
  select(unique_stations, latitude, longitude) %>%
  unique()

tn_income_plt + 
  geom_text_repel(data = xy_hosp, aes(x=x,y=y,label = mname),cex = 1.5) +
  geom_point(data = xy_hosp, aes(x=x,y=y,size = total_cases_zip1),colour = "darkblue")


chargingtypeColor <- colorFactor(rainbow(65), nashville_stations$unique_stations)


tn_chargers_leaflet <- 
  leaflet(nashville_stations) %>% 
    addTiles() %>% 
    addCircleMarkers(
        data = nashville_stations, 
                color = ~chargingtypeColor(unique_stations),

        lat = ~latitude, 
        lng = ~longitude, 
        popup = paste(nashville_stations$station_name)
    )

# for printing the maps
htmltools::tagList(tn_chargers_leaflet)
```
